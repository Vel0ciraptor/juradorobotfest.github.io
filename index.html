<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puntuación Vehículos Seguidores de Línea</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #0f1c3f;
            color: #f5f5f5;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Estilo para el fondo estrellado */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            animation: twinkle 2s infinite ease-in-out;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: rgba(25, 34, 66, 0.85);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(87, 181, 255, 0.3);
            backdrop-filter: blur(5px);
        }
        
        h1 {
            text-align: center;
            color: #7caeff;
            text-shadow: 0 0 8px rgba(124, 174, 255, 0.5);
            margin-bottom: 25px;
        }
        
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #344178;
            border-radius: 5px;
            background-color: rgba(32, 43, 81, 0.7);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            box-shadow: 0 4px 12px rgba(87, 181, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .timer-display {
            font-size: 24px;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
            color: #7caeff;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px; /* Espacio entre botones */
            width: 100%; /* Asegura que ocupe todo el ancho */
        }
        
        .controls button {
    flex-grow: 1; /* Los botones crecerán proporcionalmente */
    min-width: 120px; /* Ancho mínimo para mantener legibilidad */
    max-width: 300px; /* Ancho máximo opcional para evitar que se estiren demasiado */
    text-align: center;
}
        
        .penalties {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .score {
            font-size: 22px;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(44, 62, 80, 0.7);
            color: white;
            box-shadow: 0 0 15px rgba(87, 181, 255, 0.4);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 15px rgba(87, 181, 255, 0.4); }
            50% { box-shadow: 0 0 25px rgba(87, 181, 255, 0.6); }
            100% { box-shadow: 0 0 15px rgba(87, 181, 255, 0.4); }
        }
        
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: #344178;
            transition: all 0.3s ease;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }
        
        .section-active {
            background-color: #27ae60;
            box-shadow: 0 0 10px #2ecc71;
        }
        
        .section-completed {
            background-color: #3498db;
            box-shadow: 0 0 10px #3498db;
        }
        
        .history {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #344178;
            border-radius: 5px;
            background-color: rgba(27, 38, 72, 0.7);
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid #344178;
            color: #ddd;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .section-time {
            font-weight: bold;
            margin-right: 10px;
            color: #7caeff;
        }
        
        .reset-container {
            text-align: center;
            margin-top: 20px;
        }
        
        /* Estilos para el selector de ID y emoticones */
        .vehicle-id-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #344178;
            border-radius: 5px;
            background-color: rgba(25, 46, 120, 0.7);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .emoticon-selector {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .emoticon-option {
            font-size: 24px;
            cursor: pointer;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            background-color: rgba(22, 36, 82, 0.7);
        }
        
        .emoticon-option:hover {
            background-color: rgba(60, 82, 150, 0.7);
            transform: scale(1.1);
        }
        
        .emoticon-selected {
            background-color: rgba(87, 119, 201, 0.7);
            box-shadow: 0 0 10px rgba(87, 181, 255, 0.5);
        }
        
        .vehicle-details {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(22, 36, 82, 0.7);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .vehicle-emoji {
            font-size: 36px;
            margin-right: 15px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
        }
        
        .track-visualization {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #344178;
            border-radius: 5px;
            background-color: rgba(22, 36, 82, 0.7);
        }
        
        .track {
            position: relative;
            height: 180px;
            background-color: #1a1a2e;
            border-radius: 40px;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
        }
        
        .track-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: #fff;
            transform: translateY(-50%);
            z-index: 1;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }
        
        .track-section {
            position: absolute;
            top: 0;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.05);
            z-index: 0;
            transition: background-color 0.3s ease;
        }
        
        .track-section.active {
            background-color: rgba(46, 204, 113, 0.1);
        }
        
        .track-section.completed {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .section-1 {
            left: 0;
            width: 33.33%;
            border-right: 3px dashed rgba(255, 255, 255, 0.3);
        }
        
        .section-2 {
            left: 33.33%;
            width: 33.33%;
            border-right: 3px dashed rgba(255, 255, 255, 0.3);
        }
        
        .section-3 {
            left: 66.66%;
            width: 33.33%;
        }
        
        .section-label {
            position: absolute;
            bottom: 10px;
            color: white;
            font-weight: bold;
            z-index: 2;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        }
        
        .section-1-label {
            left: 15%;
        }
        
        .section-2-label {
            left: 49%;
        }
        
        .section-3-label {
            left: 82%;
        }
        
        .track-vehicle {
            position: absolute;
            font-size: 28px;
            z-index: 3;
            top: 50%;
            transform: translateY(-50%);
            transition: left 0.8s ease;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
        }
        
        .id-input {
            padding: 10px 12px; /* Más espacio horizontal en móviles */
    border: 1px solid #344178;
    border-radius: 4px;
    font-size: clamp(14px, 3vw, 16px); /* Tamaño de fuente responsivo */
    width: 100%;
    max-width: 100%; /* Previene desbordamiento */
    margin-bottom: 10px;
    background-color: rgba(22, 36, 82, 0.7);
    color: white;
    box-sizing: border-box; /* Incluye padding en el ancho total */
    
    /* Mejoras para móviles */
    -webkit-appearance: none; /* Elimina estilos nativos en iOS */
    min-height: 44px; /* Tamaño mínimo táctil recomendado */
    
    /* Transición suave para focus */
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* Estilo para estado focus */
.id-input:focus {
    outline: none;
    border-color: #7caeff;
    box-shadow: 0 0 0 2px rgba(124, 174, 255, 0.3);
}

/* Placeholder responsivo */
.id-input::placeholder {
    color: #8f9bbc;
    font-size: clamp(12px, 2.5vw, 14px);
    opacity: 1; /* Firefox reduce opacidad por defecto */
}

/* Media queries para ajustes específicos */
@media (max-width: 768px) {
    .id-input {
        padding: 12px 14px; /* Más grande en móviles */
        font-size: 15px; /* Tamaño fijo para mejor legibilidad */
    }
}

@media (max-width: 480px) {
    .id-input {
        padding: 14px 16px;
        min-height: 48px; /* Más grande para pantallas pequeñas */
    }
    
    .id-input::placeholder {
        font-size: 14px;
    }
}
        
        /* Estilos para la tabla de resultados */
        .results-section {
            overflow-x: auto; /* Permite desplazamiento horizontal */
                -webkit-overflow-scrolling: touch; /* Mejor desplazamiento en móviles */
        }
    
        .results-table {
            min-width: 600px; /* Ancho mínimo para mantener legibilidad */
            width: 100%;
        }

        @media (max-width: 768px) {
            .results-table {
             font-size: 14px; /* Reducir tamaño de fuente en móviles */
            }
    
    .results-table th, 
    .results-table td {
        padding: 8px 4px; /* Reducir padding en móviles */
    }
}
        .results-section {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #344178;
            border-radius: 5px;
            background-color: rgba(25, 46, 120, 0.7);
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .results-table th, .results-table td {
            border: 1px solid #344178;
            padding: 12px 8px;
            text-align: center;
        }
        
        .results-table th {
            background-color: #3498db;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .results-table tr:nth-child(even) {
            background-color: rgba(32, 43, 81, 0.7);
        }
        
        .results-table tr:nth-child(odd) {
            background-color: rgba(27, 38, 72, 0.7);
        }
        
        .results-table tr:hover {
            background-color: rgba(52, 73, 126, 0.7);
        }
        
        .empty-table-message {
            text-align: center;
            padding: 20px;
            color: #8f9bbc;
            font-style: italic;
        }
        
        .export-btn {
            display: block;
            margin: 20px auto;
            padding: 12px 24px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background-color: #1a252f;
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.4);
        }
        
        .export-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* Estilo para aviso de datos guardados */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            background-color: rgba(46, 204, 113, 0.9);
            color: white;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .alert.show {
            opacity: 1;
        }
        
        /* Personalización del scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(26, 37, 68, 0.5);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(87, 119, 201, 0.7);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(87, 119, 201, 0.9);
        }

        /* Estilos para la sección única con los tres tiempos */
        .times-container {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .time-box {
            width: 30%;
            background-color: rgba(22, 36, 82, 0.7);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .time-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .time-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #7caeff;
        }

        /* Estilos para los botones de checkpoint - Semáforo verde brillante */
.checkpoint-buttons {
    display: flex;
    justify-content: center;
    margin: 15px 0;
    flex-wrap: wrap;
    gap: 10px;
}

.traffic-light {
    position: relative;
    padding-left: 50px;
    min-height: 10px;
    display: flex;
    align-items: center;
    background-color: #2c3e50;
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.traffic-light .light {
    position: absolute;
    left: 8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #2ecc71;
    box-shadow: 0 0 10px #2ecc71, 
                0 0 20px #2ecc71,
                inset 0 0 5px rgba(255, 255, 255, 0.5);
    animation: pulse-green 1.5s infinite alternate;
}

.traffic-light:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.traffic-light:disabled {
    background-color: #95a5a6;
    cursor: not-allowed;
    opacity: 0.7;
}

.traffic-light:disabled .light {
    background-color: #34495e;
    box-shadow: none;
    animation: none;
}

@keyframes pulse-green {
    0% {
        box-shadow: 0 0 5px #2ecc71, 
                    0 0 10px #2ecc71,
                    inset 0 0 3px rgba(255, 255, 255, 0.5);
    }
    100% {
        box-shadow: 0 0 15px #2ecc71, 
                    0 0 30px #2ecc71,
                    inset 0 0 5px rgba(255, 255, 255, 0.8);
    }
}

/* Ajustes para móviles */
@media (max-width: 768px) {
    .checkpoint-buttons {
        flex-direction: column;
    }
    
    .traffic-light {
        width: 100%;
        margin: 5px 0;
    }
}

        /* Media Queries para diseño responsivo */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .time-box {
                width: 100%;
                margin-bottom: 15px;
            }
            
            .controls button, .penalties button {
                margin-bottom: 10px;
                width: 100%;
            }
            
            .penalties {
                flex-direction: column;
            }
            
            .checkpoint-buttons {
                flex-direction: column;
            }
            
            .checkpoint-btn {
                margin: 5px 0;
                width: 100%;
            }
            
            .vehicle-details {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .vehicle-emoji {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            #saveVehicleId {
                margin-top: 10px;
                width: 100%;
            }
            
            .emoticon-selector {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .track {
                height: 120px;
            }
            
            .section-label {
                font-size: 12px;
            }
            
            .timer-display {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .section {
                padding: 10px;
            }
            
            .timer-display {
                font-size: 18px;
            }
            
            .score {
                font-size: 18px;
                padding: 10px;
            }
            
            .emoticon-selector {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .track {
                height: 100px;
                border-radius: 20px;
            }
            
            .track-vehicle {
                font-size: 20px;
            }
            
            .section-label {
                font-size: 10px;
                bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Fondo estrellado -->
    <div class="stars" id="stars"></div>
    
    <!-- Alerta para notificaciones -->
    <div class="alert" id="alert">Datos guardados con éxito</div>
    
    <div class="container">
        <h1>Puntuación Vehículos Seguidores de Línea</h1>
        
        <!-- Sección de ID y Emoticón del Vehículo -->
        <div class="vehicle-id-section">
            <h2>Identificación del Vehículo</h2>
            <input type="text" id="vehicleId" class="id-input" placeholder="Ingrese ID del vehículo (Ej: Equipo A, Robot 1, etc.)">
            
            <h3>Seleccione un emoticón:</h3>
            <div class="emoticon-selector" id="emoticonSelector">
                <div class="emoticon-option" data-emoji="🚗">🚗</div>
                <div class="emoticon-option" data-emoji="🏎️">🏎️</div>
                <div class="emoticon-option" data-emoji="🚙">🚙</div>
                <div class="emoticon-option" data-emoji="🚓">🚓</div>
                <div class="emoticon-option" data-emoji="🚀">🚀</div>
                <div class="emoticon-option" data-emoji="🤖">🤖</div>
                <div class="emoticon-option" data-emoji="🦾">🦾</div>
                <div class="emoticon-option" data-emoji="⚡">⚡</div>
                <div class="emoticon-option" data-emoji="🔥">🔥</div>
                <div class="emoticon-option" data-emoji="💯">💯</div>
                <div class="emoticon-option" data-emoji="🌟">🌟</div>
                <div class="emoticon-option" data-emoji="🎯">🎯</div>
                <div class="emoticon-option" data-emoji="🚂">🚂</div>
                <div class="emoticon-option" data-emoji="🛵">🛵</div>
                <div class="emoticon-option" data-emoji="🦿">🦿</div>
                <div class="emoticon-option" data-emoji="📱">📱</div>
            </div>
            
            <div class="vehicle-details">
                <div class="vehicle-emoji" id="selectedEmoji">🚗</div>
                <div>
                    <h3>Vehículo activo:</h3>
                    <p id="activeVehicleId">Sin identificar</p>
                </div>
                <button class="btn-primary" id="saveVehicleId" style="margin-left: auto;">Guardar ID</button>
            </div>
        </div>
        
        <!-- Visualización de la Pista -->
        <div class="track-visualization">
            <h2>Pista de Seguimiento de Línea</h2>
            <div class="track">
                <div class="track-line"></div>
                <div class="track-section section-1" id="trackSection1"></div>
                <div class="track-section section-2" id="trackSection2"></div>
                <div class="track-section section-3" id="trackSection3"></div>
                <div class="section-label section-1-label">Sección 1</div>
                <div class="section-label section-2-label">Sección 2</div>
                <div class="section-label section-3-label">Sección 3</div>
                <div class="track-vehicle" id="trackVehicle" style="left: 5%;">🚗</div>
            </div>
        </div>
        
        
        <!-- SECCIÓN ÚNICA CON LOS TRES TIEMPOS -->
        <div class="section" id="unified-section">
            <div class="section-title">
                <h2>Control de Recorrido</h2>
                <span id="section-status">En espera</span>
            </div>
            
            <!-- Contenedor de los tres tiempos -->
            <div class="times-container">
                <div class="time-box">
                    <div class="time-label">Tiempo Sección 1</div>
                    <div class="timer-display" id="timer1">00:00</div>
                </div>
                <div class="time-box">
                    <div class="time-label">Tiempo Sección 2</div>
                    <div class="timer-display" id="timer2">00:00</div>
                </div>
                <div class="time-box">
                    <div class="time-label">Tiempo Sección 3</div>
                    <div class="timer-display" id="timer3">00:00</div>
                </div>
            </div>
            
            <div class="score">
                Puntuación Total: <span id="totalScore">100</span>
            </div>
            
            <!-- Controles principales -->
            <div class="checkpoint-buttons">
                <button class="checkpoint-btn traffic-light" id="checkpoint1" disabled>
                <span class="light"></span>
                Sección 1 
            </button>
                <button class="checkpoint-btn traffic-light" id="checkpoint2" disabled>
                <span class="light"></span>
                Sección 2
            </button>
            </div>
            
            
            <div class="controls">
                <button class="btn-primary" id="startRun">Iniciar Recorrido</button>
                <button class="btn-warning" id="pauseRun" disabled>Pausar</button>
                <button class="btn-success" id="completeRun" disabled>Completar Recorrido</button>
            </div>
            
            <!-- Penalizaciones -->
            <div class="penalties">
                <button class="btn-danger" id="linePenalty" disabled>Fuera de Línea (-5)</button>
                <button class="btn-danger" id="framePenalty" disabled>Fuera del Marco (-20)</button>
            </div>
        </div>
        
        <!-- Nueva sección de resultados -->
        <div class="results-section">
            <h2>Registro de Resultados</h2>
            <p>Aquí se guardan los resultados de todos los vehículos que han completado el recorrido:</p>
            
            <table class="results-table" id="resultsTable">
                <thead>
                    <tr>
                        <th>Vehículo</th>
                        <th>Identificador</th>
                        <th>Puntuación</th>
                        <th>Tiempo Sección 1</th>
                        <th>Tiempo Sección 2</th>
                        <th>Tiempo Sección 3</th>
                        <th>Tiempo Total</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                    <tr>
                        <td colspan="7" class="empty-table-message">No hay resultados registrados</td>
                    </tr>
                </tbody>
            </table>
            
            <button class="export-btn" id="exportResults" disabled>Exportar Resultados (CSV)</button>
        </div>
        
        
        <div class="reset-container">
            <button class="btn-danger" id="resetAll">Reiniciar Todo</button>
            <button class="btn-warning" id="saveCurrentVehicle" style="margin-left: 10px;">Guardar Resultados y Nuevo Vehículo</button>
        </div>
    </div>
    
        <div class="history">
            <h3>Historial</h3>
            <div id="historyList"></div>
        </div>

    <script>
        // Estado de la aplicación
        const appState = {
            currentSection: 0,
            totalScore: 100,
            vehicleId: "Sin identificar",
            vehicleEmoji: "🚗",
            running: false,
            paused: false,
            timer: null,
            startTime: 0,
            elapsedTime: 0,
            sections: [
                { completed: false, time: 0, checkpoint: 0 },
                { completed: false, time: 0, checkpoint: 0 },
                { completed: false, time: 0, checkpoint: 0 }
            ],
            penalties: [],
            results: []
        };

        // Elementos DOM
        const domElements = {
            totalScore: document.getElementById('totalScore'),
            indicators: [
                document.getElementById('trackSection1'),
                document.getElementById('trackSection2'),
                document.getElementById('trackSection3')
            ],
            timers: [
                document.getElementById('timer1'),
                document.getElementById('timer2'),
                document.getElementById('timer3')
            ],
            sectionStatus: document.getElementById('section-status'),
            startRun: document.getElementById('startRun'),
            pauseRun: document.getElementById('pauseRun'),
            completeRun: document.getElementById('completeRun'),
            checkpoint1: document.getElementById('checkpoint1'),
            checkpoint2: document.getElementById('checkpoint2'),
            linePenalty: document.getElementById('linePenalty'),
            framePenalty: document.getElementById('framePenalty'),
            historyList: document.getElementById('historyList'),
            resetAll: document.getElementById('resetAll'),
            // Elementos para el ID y emoticón
            vehicleIdInput: document.getElementById('vehicleId'),
            emoticonSelector: document.getElementById('emoticonSelector'),
            selectedEmoji: document.getElementById('selectedEmoji'),
            activeVehicleId: document.getElementById('activeVehicleId'),
            saveVehicleId: document.getElementById('saveVehicleId'),
            trackVehicle: document.getElementById('trackVehicle'),
            // Elementos para guardar resultados
            saveCurrentVehicle: document.getElementById('saveCurrentVehicle'),
            resultsTableBody: document.getElementById('resultsTableBody'),
            exportResults: document.getElementById('exportResults'),
            alert: document.getElementById('alert'),
            // Sección estrellada
            stars: document.getElementById('stars')
        };

        // Inicializar el fondo estrellado
        function createStars() {
            const starsCount = 150;
            
            for (let i = 0; i < starsCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // Tamaño aleatorio para las estrellas
                const size = Math.random() * 3;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                
                // Posición aleatoria
                const posX = Math.random() * 100;
                const posY = Math.random() * 100;
                star.style.left = `${posX}%`;
                star.style.top = `${posY}%`;
                
                // Animación con retraso aleatorio
                star.style.animationDelay = `${Math.random() * 2}s`;
                
                domElements.stars.appendChild(star);
            }
        }

        // Formatear tiempo en formato MM:SS.ms
        function formatTime(timeInMs) {
            const minutes = Math.floor(timeInMs / 60000);
            const seconds = Math.floor((timeInMs % 60000) / 1000);
            const ms = Math.floor((timeInMs % 1000) / 10);
            
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
        }

        // Mostrar alerta con mensaje
        function showAlert(message) {
            domElements.alert.textContent = message;
            domElements.alert.classList.add('show');
            
            setTimeout(() => {
                domElements.alert.classList.remove('show');
            }, 3000);
        }

        // Actualizar visualización de la pista
        function updateTrackVisualization() {
            // Actualizar visualización de secciones completadas
            for (let i = 0; i < 3; i++) {
                if (appState.sections[i].completed) {
                    domElements.indicators[i].classList.add('completed');
                    domElements.indicators[i].classList.remove('active');
                } else if (i === appState.currentSection) {
                    domElements.indicators[i].classList.add('active');
                    domElements.indicators[i].classList.remove('completed');
                } else {
                    domElements.indicators[i].classList.remove('active', 'completed');
                    // Continuación del código desde donde se truncó

                }
            }

            // Actualizar posición del vehículo en la pista
            let vehiclePos = 5; // Posición inicial (%)
            
            if (appState.currentSection === 0) {
                vehiclePos = appState.running ? 15 : 5;
            } else if (appState.currentSection === 1) {
                vehiclePos = 49;
            } else if (appState.currentSection === 2) {
                vehiclePos = 82;
            }
            
            domElements.trackVehicle.style.left = `${vehiclePos}%`;
            domElements.trackVehicle.textContent = appState.vehicleEmoji;
        }

        // Actualizar el estado de la sección
        function updateSectionStatus() {
            let status = "En espera";
            
            if (appState.running) {
                if (appState.paused) {
                    status = "Pausado";
                } else {
                    status = `Sección ${appState.currentSection + 1} en curso`;
                }
            } else if (appState.sections[2].completed) {
                status = "Recorrido completado";
            }
            
            domElements.sectionStatus.textContent = status;
        }

        // Iniciar el recorrido
        function startRun() {
            if (appState.vehicleId === "Sin identificar") {
                showAlert("Por favor, identifique el vehículo antes de iniciar");
                return;
            }
            
            if (!appState.running) {
                appState.running = true;
                appState.paused = false;
                appState.currentSection = 0;
                appState.startTime = Date.now() - appState.elapsedTime;
                
                domElements.startRun.disabled = true;
                domElements.pauseRun.disabled = false;
                domElements.completeRun.disabled = false;
                domElements.checkpoint1.disabled = false;
                domElements.linePenalty.disabled = false;
                domElements.framePenalty.disabled = false;
                domElements.saveVehicleId.disabled = true;
                domElements.vehicleIdInput.disabled = true;
                
                // Iniciar el cronómetro
                appState.timer = setInterval(updateTimer, 10);
                
                addToHistory(`Recorrido iniciado para ${appState.vehicleId} ${appState.vehicleEmoji}`);
                updateSectionStatus();
            }
            
            updateTrackVisualization();
        }

        // Pausar el recorrido
        function pauseRun() {
            if (appState.running && !appState.paused) {
                appState.paused = true;
                clearInterval(appState.timer);
                
                domElements.pauseRun.textContent = "Reanudar";
                addToHistory("Recorrido pausado");
            } else if (appState.running && appState.paused) {
                appState.paused = false;
                appState.startTime = Date.now() - appState.elapsedTime;
                appState.timer = setInterval(updateTimer, 10);
                
                domElements.pauseRun.textContent = "Pausar";
                addToHistory("Recorrido reanudado");
            }
            
            updateSectionStatus();
        }

        // Completar el recorrido
        function completeRun() {
    if (!appState.running) return;
    
    clearInterval(appState.timer);
    
    // Calcular el tiempo de la sección actual
    const sectionStartTime = appState.currentSection > 0 ? 
        appState.sections[appState.currentSection - 1].time + 
        (appState.currentSection > 1 ? appState.sections[appState.currentSection - 2].time : 0) : 0;
    appState.sections[appState.currentSection].time = appState.elapsedTime - sectionStartTime;
    appState.sections[appState.currentSection].completed = true;
    
    // Si no estamos en la última sección, avanzar a la siguiente
    if (appState.currentSection < 2) {
        appState.currentSection++;
        appState.timer = setInterval(updateTimer, 10);
        
        if (appState.currentSection === 1) {
            domElements.checkpoint1.disabled = true;
            domElements.checkpoint2.disabled = false;
            addToHistory("Sección 1 completada");
        } else {
            domElements.checkpoint2.disabled = true;
            addToHistory("Sección 2 completada");
        }
    } else {
        // Completar el recorrido entero
        appState.running = false;
        domElements.startRun.disabled = false;
        domElements.pauseRun.disabled = true;
        domElements.completeRun.disabled = true;
        domElements.linePenalty.disabled = true;
        domElements.framePenalty.disabled = true;
        domElements.pauseRun.textContent = "Pausar";
        domElements.saveVehicleId.disabled = false;
        domElements.vehicleIdInput.disabled = false;
        
        addToHistory("Recorrido completado");
        showAlert("¡Recorrido completado!");
    }
    
    updateSectionStatus();
    updateTrackVisualization();
}

        // Registrar checkpoint
        function registerCheckpoint(checkpointNum) {
            if (!appState.running || appState.paused) return;
            
            if (checkpointNum === 1 && appState.currentSection === 0) {
                appState.sections[0].checkpoint = appState.elapsedTime;
                addToHistory("Checkpoint 1 registrado");
            } else if (checkpointNum === 2 && appState.currentSection === 1) {
                appState.sections[1].checkpoint = appState.elapsedTime - appState.sections[0].time;
                addToHistory("Checkpoint 2 registrado");
            }
        }

        // Aplicar penalización por salirse de la línea
        function applyLinePenalty() {
            if (!appState.running || appState.paused) return;
            
            appState.totalScore -= 5;
            domElements.totalScore.textContent = appState.totalScore;
            
            appState.penalties.push({
                time: appState.elapsedTime,
                type: "line",
                section: appState.currentSection + 1,
                points: 5
            });
            
            addToHistory(`Penalización: Fuera de línea (-5) en Sección ${appState.currentSection + 1}`);
        }

        // Aplicar penalización por salirse del marco
        function applyFramePenalty() {
            if (!appState.running || appState.paused) return;
            
            appState.totalScore -= 20;
            domElements.totalScore.textContent = appState.totalScore;
            
            appState.penalties.push({
                time: appState.elapsedTime,
                type: "frame",
                section: appState.currentSection + 1,
                points: 20
            });
            
            addToHistory(`Penalización: Fuera del marco (-20) en Sección ${appState.currentSection + 1}`);
        }

        // Actualizar el cronómetro
        function updateTimer() {
    if (appState.running && !appState.paused) {
        appState.elapsedTime = Date.now() - appState.startTime;
        
        // Actualizar el temporizador de la sección actual
        for (let i = 0; i <= appState.currentSection; i++) {
            if (i < appState.currentSection) {
                // Para secciones completadas, mostrar el tiempo guardado
                domElements.timers[i].textContent = formatTime(appState.sections[i].time);
            } else {
                // Para la sección actual, calcular el tiempo transcurrido desde el inicio de la sección
                const sectionStartTime = i > 0 ? 
                    appState.sections[i-1].time + (i > 1 ? appState.sections[i-2].time : 0) : 0;
                const sectionTime = appState.elapsedTime - sectionStartTime;
                domElements.timers[i].textContent = formatTime(sectionTime);
                
                // Guardar el tiempo actual en la sección (para cuando se complete)
                appState.sections[i].time = sectionTime;
            }
        }
    }
}

        // Añadir entrada al historial
        function addToHistory(message) {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'section-time';
            timeSpan.textContent = formatTime(appState.elapsedTime);
            
            historyItem.appendChild(timeSpan);
            historyItem.appendChild(document.createTextNode(message));
            
            domElements.historyList.insertBefore(historyItem, domElements.historyList.firstChild);
        }

        // Guardar ID y emoticón del vehículo
        function saveVehicleId() {
            const newId = domElements.vehicleIdInput.value.trim();
            
            if (newId === "") {
                showAlert("Por favor, ingrese un ID para el vehículo");
                return;
            }
            
            appState.vehicleId = newId;
            domElements.activeVehicleId.textContent = newId;
            
            addToHistory(`Vehículo identificado como: ${appState.vehicleId} ${appState.vehicleEmoji}`);
            showAlert("ID de vehículo guardado");
        }

        // Seleccionar emoticón para el vehículo
        function selectEmoticon(event) {
            if (event.target.classList.contains('emoticon-option')) {
                const emoji = event.target.getAttribute('data-emoji');
                
                // Actualizar selección visual
                document.querySelectorAll('.emoticon-option').forEach(option => {
                    option.classList.remove('emoticon-selected');
                });
                event.target.classList.add('emoticon-selected');
                
                // Actualizar emoji seleccionado
                appState.vehicleEmoji = emoji;
                domElements.selectedEmoji.textContent = emoji;
                domElements.trackVehicle.textContent = emoji;
            }
        }

        // Guardar resultados del vehículo actual
        function saveVehicleResults() {
            if (appState.vehicleId === "Sin identificar") {
                showAlert("Por favor, identifique el vehículo antes de guardar");
                return;
            }
            
            if (!appState.sections[2].completed) {
                if (!confirm("El recorrido no está completo. ¿Desea guardar los resultados parciales?")) {
                    return;
                }
            }
            
            // Calcular tiempo total
            const totalTime = appState.sections[0].time + appState.sections[1].time + appState.sections[2].time;
            
            // Crear objeto de resultado
            const result = {
                emoji: appState.vehicleEmoji,
                id: appState.vehicleId,
                score: appState.totalScore,
                section1Time: appState.sections[0].time,
                section2Time: appState.sections[1].time,
                section3Time: appState.sections[2].time,
                totalTime: totalTime,
                penalties: [...appState.penalties]
            };
            
            // Añadir a resultados
            appState.results.push(result);
            
            // Actualizar tabla de resultados
            updateResultsTable();
            
            // Habilitar botón de exportar si hay resultados
            if (appState.results.length > 0) {
                domElements.exportResults.disabled = false;
            }
            
            // Reiniciar para nuevo vehículo
            resetCurrentVehicle();
            showAlert("Resultados guardados correctamente");
        }

        // Actualizar la tabla de resultados
        function updateResultsTable() {
            // Limpiar tabla
            domElements.resultsTableBody.innerHTML = '';
            
            if (appState.results.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="empty-table-message">No hay resultados registrados</td>`;
                domElements.resultsTableBody.appendChild(row);
                return;
            }
            
            // Ordenar resultados por puntuación (de mayor a menor)
            const sortedResults = [...appState.results].sort((a, b) => {
                // Primero por puntuación
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                // Si hay empate, por tiempo total
                return a.totalTime - b.totalTime;
            });
            
            // Añadir filas
            sortedResults.forEach(result => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${result.emoji}</td>
                    <td>${result.id}</td>
                    <td>${result.score}</td>
                    <td>${formatTime(result.section1Time)}</td>
                    <td>${formatTime(result.section2Time)}</td>
                    <td>${formatTime(result.section3Time)}</td>
                    <td>${formatTime(result.totalTime)}</td>
                `;
                
                domElements.resultsTableBody.appendChild(row);
            });
        }

        // Exportar resultados a CSV
        function exportResultsToCSV() {
            if (appState.results.length === 0) {
                showAlert("No hay resultados para exportar");
                return;
            }
            
            // Crear cabecera CSV
            let csv = 'Vehículo,Identificador,Puntuación,Tiempo Sección 1,Tiempo Sección 2,Tiempo Sección 3,Tiempo Total\n';
            
            // Añadir filas
            appState.results.forEach(result => {
                csv += `${result.emoji},${result.id},${result.score},${formatTime(result.section1Time)},${formatTime(result.section2Time)},${formatTime(result.section3Time)},${formatTime(result.totalTime)}\n`;
            });
            
            // Crear blob y descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            // Nombre del archivo con fecha y hora
            const now = new Date();
            const fileName = `resultados_seguidores_linea_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert("Resultados exportados correctamente");
        }

        // Reiniciar para un nuevo vehículo (mantiene los resultados guardados)
        function resetCurrentVehicle() {
            // Detener cualquier timer activo
            if (appState.timer) {
                clearInterval(appState.timer);
            }
            
            // Reiniciar estado
            appState.currentSection = 0;
            appState.totalScore = 100;
            appState.running = false;
            appState.paused = false;
            appState.elapsedTime = 0;
            appState.sections = [
                { completed: false, time: 0, checkpoint: 0 },
                { completed: false, time: 0, checkpoint: 0 },
                { completed: false, time: 0, checkpoint: 0 }
            ];
            appState.penalties = [];
            
            // Reiniciar visualización
            domElements.totalScore.textContent = appState.totalScore;
            domElements.timers.forEach(timer => {
                timer.textContent = "00:00";
            });
            
            // Reiniciar botones
            domElements.startRun.disabled = false;
            domElements.pauseRun.disabled = true;
            domElements.completeRun.disabled = true;
            domElements.checkpoint1.disabled = true;
            domElements.checkpoint2.disabled = true;
            domElements.linePenalty.disabled = true;
            domElements.framePenalty.disabled = true;
            domElements.pauseRun.textContent = "Pausar";
            domElements.saveVehicleId.disabled = false;
            domElements.vehicleIdInput.disabled = false;
            
            // Limpiar historial
            domElements.historyList.innerHTML = '';
            
            // Reiniciar visualización de la pista
            updateTrackVisualization();
            updateSectionStatus();
            
            addToHistory("Sistema reiniciado para nuevo vehículo");
        }

        // Reiniciar completamente la aplicación
        function resetAll() {
            if (appState.results.length > 0) {
                if (!confirm("¿Está seguro de que desea reiniciar todo? Se perderán todos los resultados guardados.")) {
                    return;
                }
            }
            
            // Reiniciar vehículo actual
            resetCurrentVehicle();
            
            // Además, reiniciar ID y emoticón
            appState.vehicleId = "Sin identificar";
            appState.vehicleEmoji = "🚗";
            domElements.activeVehicleId.textContent = "Sin identificar";
            domElements.selectedEmoji.textContent = "🚗";
            domElements.vehicleIdInput.value = "";
            
            // Limpiar selección de emoticón
            document.querySelectorAll('.emoticon-option').forEach(option => {
                option.classList.remove('emoticon-selected');
            });
            document.querySelector('[data-emoji="🚗"]').classList.add('emoticon-selected');
            
            // Limpiar resultados
            appState.results = [];
            updateResultsTable();
            domElements.exportResults.disabled = true;
            
            showAlert("Sistema reiniciado completamente");
        }

        // Inicializar eventos
        function initEvents() {
            // Eventos de los botones principales
            domElements.startRun.addEventListener('click', startRun);
            domElements.pauseRun.addEventListener('click', pauseRun);
            domElements.completeRun.addEventListener('click', completeRun);
            domElements.resetAll.addEventListener('click', resetAll);
            
            // Eventos para penalizaciones
            domElements.linePenalty.addEventListener('click', applyLinePenalty);
            domElements.framePenalty.addEventListener('click', applyFramePenalty);
            
            // Eventos para checkpoints
            domElements.checkpoint1.addEventListener('click', () => registerCheckpoint(1));
            domElements.checkpoint2.addEventListener('click', () => registerCheckpoint(2));
            
            // Eventos para ID y emoticón
            domElements.saveVehicleId.addEventListener('click', saveVehicleId);
            domElements.emoticonSelector.addEventListener('click', selectEmoticon);
            
            // Evento para guardar vehículo
            domElements.saveCurrentVehicle.addEventListener('click', saveVehicleResults);
            
            // Evento para exportar resultados
            domElements.exportResults.addEventListener('click', exportResultsToCSV);
            
            // Inicializar estado del emoticón por defecto
            document.querySelector('[data-emoji="🚗"]').classList.add('emoticon-selected');
        }

        // Inicializar la aplicación
        function initApp() {
            createStars();
            initEvents();
            updateTrackVisualization();
            updateSectionStatus();
        }

        // Iniciar la aplicación cuando se carga la página
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
